#!/usr/bin/env bash

set -e

top_srcdir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
top_builddir="$(pwd)"

makefiles=( \
	Makefile.in \
	pop/Makefile.in \
	tools/Makefile.in \
	tests/Makefile.in \
)

for mk in ${makefiles[@]}
do
	mksfile="${top_srcdir}/${mk}"
	mkdfile="${top_builddir}/${mk%.in}"
	srcdir="$(dirname "${mksfile}")"
	builddir="$(dirname ${mkdfile})"
	mkdir -p "${srcdir}" "${builddir}"

	# write pre-amble
	cat > "${mkdfile}" << END
### Auto-generated preamble

top_builddir := ${top_builddir}
top_srcdir   := ${top_srcdir}
builddir     := ${builddir}
srcdir       := ${srcdir}

### Content from ${top_srcdir}/Makefile.common

END

	# write common makefile content
	cat "${top_srcdir}/Makefile.common" >> "${mkdfile}"

	cat >> "${mkdfile}" << END

### Content from ${mksfile}

END

	# insert the rest of the makefile
	cat "${mksfile}" >> "${mkdfile}"

	# insert the end matter
	cat >> "${mkdfile}" << END

#### Auto-generated end matter

-include \$(DEPENDS)

.PHONY: all clean
END

done
